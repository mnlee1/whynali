# 이슈 상태 전환 규격

이슈 상태(점화/논란중/종결)의 의미, 전환 조건, 자동/수동 처리 방식을 정의한다.
판단 근거: 02_AI기획_판단포인트.md §6.3, 07_이슈등록_화력_정렬_규격.md §2·§3.

---

## 1. 상태 정의

| 상태 | 의미 | 진입 시점 |
|------|------|-----------|
| 점화 | 이슈 발생 초기, 빠르게 확산 중 | 이슈 등록(승인) 직후 기본값 |
| 논란중 | 양측 의견 대립이 지속되는 국면 | 점화 후 일정 시간 경과 + 화력 유지 |
| 종결 | 사과·해명 발표, 또는 반응 소강 | 신규 수집 없음 또는 화력 소진 |

상태는 역방향 변경이 가능하다. 종결된 이슈도 재점화될 수 있다(관리자 수동 처리).

---

## 2. 전환 흐름

```
점화 ──(시간+화력)──→ 논란중 ──(소강)──→ 종결
  └──────(화력 소진)──────────────────────↗
                              ↑ (관리자 수동, 역방향 포함)
```

- 순방향 자동 전환: 점화→논란중, 논란중→종결, 점화→종결(바이패스).
- 역방향 전환(종결→논란중 등)은 자동 없음. 관리자 수동만 허용.

---

## 3. 자동 전환 기준

### 3.1 점화 → 논란중

아래 조건을 **모두** 충족 시 자동 전환.

| 조건 | 기본값 | 환경변수 |
|------|--------|----------|
| 이슈 승인(`approved_at`) 후 경과 시간 ≥ N시간 | 6시간 | `STATUS_IGNITE_TO_DEBATE_HOURS` |
| 현재 `heat_index` ≥ M점 | 40점 | `STATUS_IGNITE_MIN_HEAT` |

- 화력이 M 미만이면 점화 상태를 유지. 화력이 계속 낮으면 3.3 조건으로 종결 직행 가능.
- 경과 시간 기준은 `approved_at` 기준이며, `NULL`이면 `created_at` 사용.

### 3.2 논란중 → 종결

아래 조건 중 **하나라도** 충족 시 자동 전환.

| 조건 | 기본값 | 환경변수 |
|------|--------|----------|
| 최근 N시간 내 신규 연결 수집 건(뉴스+커뮤니티) = 0 | 48시간 | `STATUS_CLOSED_IDLE_HOURS` |
| heat_index < K 가 M시간 이상 지속 | K=10, M=24시간 | `STATUS_CLOSED_MAX_HEAT`, `STATUS_CLOSED_LOW_HEAT_HOURS` |

- "신규 연결 수집 건": `news_data.issue_id = issue.id` 또는 `community_data.issue_id = issue.id` 중 `created_at`이 최근 N시간 이내인 건수.
- "heat_index 지속": `updated_at` 기준으로 N시간 전부터 현재까지 재계산 이력의 평균 또는 현재값 단독으로 판단. 구현 단순화 시 **현재 heat_index 단독** 사용 허용.

### 3.3 점화 → 종결 (바이패스)

논란중을 거치지 않고 바로 종결. 아래 조건이 **모두** 충족 시 자동 전환.

| 조건 | 기본값 | 환경변수 |
|------|--------|----------|
| 이슈 승인 후 경과 시간 ≥ N시간 | 6시간 | `STATUS_IGNITE_TO_DEBATE_HOURS` (동일) |
| 현재 heat_index < K | 10점 | `STATUS_CLOSED_MAX_HEAT` (동일) |

- 이슈가 등록됐지만 커뮤니티/뉴스 반응이 계속 미미한 경우 논란중 없이 바로 소강 처리.

### 3.4 자동 전환 공통 제한

- 승인(`approval_status = '승인'`) 이슈만 대상. 대기·반려 이슈는 상태 전환 제외.
- 역방향(종결→논란중, 논란중→점화 등)은 자동 전환 없음. 관리자 수동만.
- 상태 전환 시 `updated_at` 갱신 필수 (07 §3 sort_score 재계산을 위해).

---

## 4. 수동 전환 (관리자)

- 관리자 이슈 관리 페이지에서 드롭다운으로 언제든지 임의 변경 가능.
- 역방향(종결→논란중→점화) 포함.
- 사유(사과문 발표, 재점화 등)는 별도 메모 없이 변경 가능. 추후 로그 필요 시 `admin_logs` 테이블 활용.

---

## 5. Cron 구현 가이드

### 5.1 통합 방식 (권장)

`recalculate-heat` Cron(10분 주기, `app/api/cron/recalculate-heat/route.ts`)에 상태 전환 로직 추가.
화력 재계산 직후 위 3.1~3.3 조건을 평가해 `status`를 업데이트한다.

```
화력 재계산 → heat_index 저장 → 상태 전환 조건 평가 → status 업데이트 → updated_at 갱신
```

### 5.2 분리 방식 (선택)

별도 Cron `app/api/cron/auto-update-status/route.ts` 를 추가해 30분 주기로 실행.
DB 부하가 낮고 독립적으로 on/off 가능.

### 5.3 신규 연결 수집 건 쿼리 예시

```sql
-- 논란중 → 종결: 최근 48시간 신규 연결 건 확인
SELECT COUNT(*) FROM (
  SELECT id FROM news_data
  WHERE issue_id = $1 AND created_at > NOW() - INTERVAL '48 hours'
  UNION ALL
  SELECT id FROM community_data
  WHERE issue_id = $1 AND created_at > NOW() - INTERVAL '48 hours'
) t
```

---

## 6. 환경변수 정리

| 환경변수 | 기본값 | 설명 |
|----------|--------|------|
| `STATUS_IGNITE_TO_DEBATE_HOURS` | `6` | 점화→논란중 전환 최소 경과 시간(시) |
| `STATUS_IGNITE_MIN_HEAT` | `40` | 점화→논란중 전환 최소 화력 |
| `STATUS_CLOSED_IDLE_HOURS` | `48` | 종결 판단용 신규 수집 공백 기간(시) |
| `STATUS_CLOSED_MAX_HEAT` | `10` | 종결 판단용 화력 임계값 |
| `STATUS_CLOSED_LOW_HEAT_HOURS` | `24` | 화력 임계값 이하 지속 시간(시) |

---

## 7. 구현 시 체크

- [ ] recalculate-heat Cron 또는 별도 Cron에 상태 전환 로직 추가.
- [ ] 전환 조건 평가 시 `approval_status = '승인'` 필터 확인.
- [ ] 상태 변경 시 `updated_at` 갱신 (sort_score 재계산 연동 — 07 §3.5).
- [ ] 역방향 전환은 Cron에서 처리하지 않고 관리자 API에서만 허용.
- [ ] 환경변수로 임계값 조정 가능.

---

## 8. 참조 문서

- [02_AI기획_판단포인트.md](./02_AI기획_판단포인트.md): §6.3 상태 의미 정의
- [07_이슈등록_화력_정렬_규격.md](./07_이슈등록_화력_정렬_규격.md): §2 화력 지수, §3 정렬 규격
- [97_API규약.md](./97_API규약.md): 이슈 상태 필드 API 응답 형태

---

**작성일**: 2026-02-24
**용도**: 이슈 상태 자동/수동 전환 기준 및 구현 규격.
