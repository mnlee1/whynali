# 담당 B Day3-11 기능보완 개선권고 (프론트엔드/백엔드)

기준 문서: `docs/99_담당B_Day3-11_체크리스트.md`
참조 방식: 체크리스트 우선 + 실제 구현 파일 확인 기반으로 운영/품질 보완안을 정리한다.

우선순위 기준:
- Must: 보안, 정합성, 운영장애 가능성이 높은 항목
- Should: 성능/안정성/운영 효율 개선 효과가 큰 항목
- Could: 중장기 고도화 항목

---

## Day 3-4

### 프론트엔드
1) 인증 상태 동기화 단일화 필요
- 현상: `ReactionsSection`, `VoteSection`, `CommentsSection`에서 각각 `/api/auth/me`를 개별 호출
- 리스크: 화면마다 로그인 상태가 다르게 보여 사용자가 혼란을 느낄 수 있음
- 개선권고:
  - 공통 `useCurrentUser()` 훅 또는 상위 컨텍스트로 로그인 상태를 한 곳에서 관리
  - 서버에서 받은 `userId`를 우선 사용해 초기 화면 흔들림을 줄임
- 우선순위: Should
- 대상 파일:
  - `components/issue/ReactionsSection.tsx`
  - `components/issue/VoteSection.tsx`
  - `components/issue/CommentsSection.tsx`

2) 댓글 작성 에러 표현 표준화
- 현상: 작성 에러는 구분 처리하지만 조회/수정/삭제 에러는 섹션 공통 에러로 혼합
- 리스크: 무엇이 실패했는지 알기 어려워 재시도 행동이 꼬일 수 있음
- 개선권고:
  - 액션별 에러 상태(write/edit/delete/load)를 분리해 정확히 안내
  - 사용자 메시지 템플릿을 통일해 일관된 피드백 제공
- 우선순위: Should
- 대상 파일:
  - `components/issue/CommentsSection.tsx`

#### Day 3-4 UX/UI 피드백 패턴 적용
- 성공/실패 피드백 표준화 (Must)
  - 성공: 토스트 1회 + 화면 상태 즉시 반영
  - 실패: 원인(권한/검증/네트워크) 구분 문구로 안내
- 인증 상태 일관성 (Should)
  - 로그인 상태를 공통 훅/컨텍스트에서 단일 관리
  - 초기 렌더 시 사용자 상태 흔들림 최소화

### 백엔드
1) 관리자 경로 보호 미적용 상태
- 현상: `middleware.ts`는 `/api/*` 중 일부 쓰기 경로만 보호하고, `/admin`, `/api/admin` 전용 보호가 없음
- 리스크: 관리자 화면/API가 비인가 사용자에게 노출될 가능성
- 개선권고:
  - `/admin/:path*`, `/api/admin/:path*` 보호 로직을 명시적으로 추가
  - 관리자 이메일/역할 검증(`isAdminEmail`)을 middleware 또는 공통 guard로 강제
- 우선순위: Must
- 대상 파일:
  - `middleware.ts`
  - `lib/admin.ts`
  - `app/api/auth/is-admin/route.ts`

2) 댓글 검토 상태 값 불일치
- 현상:
  - 댓글 작성 시 검토 대기는 `visibility: 'pending'`
  - 관리자 대기 목록은 `visibility: 'pending_review'` 조회
- 리스크: 검토 대기 댓글이 관리자 화면에 나타나지 않는 정합성 오류
- 개선권고:
  - 상태 enum을 단일 값으로 통일(`pending_review` 또는 `pending`)
  - 관련 쿼리/업데이트를 전수 정렬
- 우선순위: Must
- 대상 파일:
  - `app/api/comments/route.ts`
  - `app/api/admin/safety/pending/route.ts`
  - `app/api/admin/safety/pending/[id]/route.ts`

3) 세이프티 검증 일관성 부족
- 현상:
  - 댓글 생성은 DB 금칙어(`safety_rules`)를 반영
  - 댓글 수정/토론 생성은 DB 금칙어 반영 없이 기본 검증만 수행
- 리스크: 동일 정책이 API마다 다르게 적용되어 우회 가능
- 개선권고:
  - 금칙어 로딩/검증을 공통 서비스 함수로 추출
  - 생성/수정/관리자 수정 API 모두 동일 정책 적용
- 우선순위: Must
- 대상 파일:
  - `app/api/comments/route.ts`
  - `app/api/comments/[id]/route.ts`
  - `app/api/discussions/route.ts`
  - `app/api/admin/discussions/[id]/route.ts`
  - `lib/safety.ts`

4) Rate Limit 저장소가 서버리스 환경에 부적합
- 현상: 메모리 Map 기반 Rate Limit 사용
- 리스크: 인스턴스 분산 시 제한 우회/비일관성 발생
- 개선권고:
  - Redis/Upstash 기반 분산 Rate Limit으로 전환
  - 사용자+엔드포인트 단위 키 설계 및 TTL 적용
- 우선순위: Must
- 대상 파일:
  - `lib/safety.ts`
  - `app/api/comments/route.ts`
  - `app/api/reactions/route.ts`
  - `app/api/votes/[id]/vote/route.ts`
  - `app/api/discussions/route.ts`

---

## Day 5-6

### 프론트엔드
1) 액션 처리 상태 미세 분리 필요
- 현상: 리액션은 섹션 전체 submitting, 투표는 vote_id 단위 submitting으로 구현 방식이 다름
- 리스크: 어떤 버튼은 눌리고 어떤 버튼은 잠겨 사용자 입장에서 동작이 헷갈림
- 개선권고:
  - 리액션/투표/댓글 모두 액션 단위 loading 정책으로 통일
  - 실패 시 롤백과 재시도 흐름을 같은 규칙으로 제공
- 우선순위: Should
- 대상 파일:
  - `components/issue/ReactionsSection.tsx`
  - `components/issue/VoteSection.tsx`
  - `components/issue/CommentsSection.tsx`

2) 검색 UX 이중 구현 정리 필요
- 현상: 검색이 `app/search/page.tsx`(서버 직접 조회)와 `/api/search`(API)로 이원화
- 리스크: 같은 검색어인데 페이지마다 결과가 다르게 보여 신뢰가 떨어질 수 있음
- 개선권고:
  - 검색 로직을 API 또는 서버액션 한 경로로 통합
  - 최소 검색 길이, limit/offset, 에러 표시 형식을 통일
- 우선순위: Should
- 대상 파일:
  - `app/search/page.tsx`
  - `app/api/search/route.ts`
  - `app/community/page.tsx`

3) 토론/커뮤니티 목록 로딩 경쟁 제어 부족
- 현상: 검색과 더보기 요청이 겹칠 때 요청 취소/최신성 보장 장치가 없음
- 리스크: 방금 바꾼 조건과 다른 오래된 목록이 화면에 다시 나타날 수 있음
- 개선권고:
  - `AbortController`로 이전 요청을 취소
  - request id 비교로 최신 응답만 화면에 반영
- 우선순위: Should
- 대상 파일:
  - `app/community/page.tsx`
  - `components/issue/CommentsSection.tsx`

#### Day 5-6 UX/UI 피드백 패턴 적용
- 로딩/중복클릭 제어 (Must)
  - 액션 버튼 클릭 즉시 로딩 표시 + disabled
  - 요청 처리 중 동일 액션 재클릭 차단
- 최신 응답 보장 (Must)
  - 검색/필터/더보기에서 이전 요청 취소
  - 마지막 요청 응답만 화면 반영
- 빈 상태/초기 상태 구분 (Should)
  - 데이터 없음, 검색 결과 없음, 로딩 후 없음 상태 분리 표시
  - 다시 시도/필터 초기화 액션 제공

### 백엔드
1) 투표 참여/취소 트랜잭션 보강
- 현상: `user_votes` insert/delete와 `vote_choices` count 증감이 분리 호출
- 리스크: 중간 실패 시 카운트 불일치
- 개선권고:
  - DB 함수 하나로 참여/취소 원자 처리
  - 실패 시 롤백 보장 및 중복 투표 race-safe 처리
- 우선순위: Must
- 대상 파일:
  - `app/api/votes/[id]/vote/route.ts`

2) 입력 파라미터 검증 상한 보강
- 현상: 여러 API에서 `limit`, `offset` 상한/음수 방어가 일관되지 않음
- 리스크: 과도 조회 및 비정상 요청으로 성능 저하
- 개선권고:
  - 공통 파라미터 파서 도입(limit max, offset min 0, 기본값)
  - 400 에러 코드/메시지 표준화
- 우선순위: Should
- 대상 파일:
  - `app/api/comments/route.ts`
  - `app/api/discussions/route.ts`
  - `app/api/admin/discussions/route.ts`
  - `app/api/search/route.ts`

3) 리액션 조회 쿼리 최적화
- 현상: 모든 리액션 row를 가져와 서버에서 count/userReaction 계산
- 리스크: 데이터 증가 시 조회 비용 증가
- 개선권고:
  - 타입별 count는 집계 쿼리로 처리
  - 사용자 반응은 단일 row 조회로 분리
- 우선순위: Could
- 대상 파일:
  - `app/api/reactions/route.ts`

---

## Day 8-11

### 프론트엔드
1) 관리자 화면 접근 가드 강화
- 현상: 체크리스트에도 명시된 것처럼 관리자 버튼/경로 보호가 미완료 상태
- 리스크: 일반 사용자에게 관리자 화면이 보이면 신뢰/보안 이슈가 동시에 발생
- 개선권고:
  - 헤더의 `isAdmin` 분기를 재활성화해 버튼 노출 자체를 제어
  - 비관리자 접근 시 관리자 페이지에서 즉시 차단 안내 제공
- 우선순위: Must
- 대상 파일:
  - `app/admin/page.tsx`
  - `app/admin/discussions/page.tsx`
  - `app/admin/safety/page.tsx`
  - `app/admin/logs/page.tsx`

2) 관리자 예시(Mock) 데이터 노출 정책 정리
- 현상: safety/logs 등 관리자 화면에서 실데이터 없을 때 mock이 표시됨
- 리스크: 운영자가 예시 데이터를 실제 데이터로 오해할 수 있음
- 개선권고:
  - 운영 환경에서는 mock 데이터를 비활성화
  - 빈 상태 문구와 다음 액션 가이드로 대체
- 우선순위: Should
- 대상 파일:
  - `app/admin/safety/page.tsx`
  - `app/admin/logs/page.tsx`

3) 관리자 액션 피드백 개선
- 현상: 일부 처리에서 `alert/confirm` 기반 동작
- 리스크: 처리 결과를 한눈에 확인하기 어려워 운영 속도가 떨어짐
- 개선권고:
  - 토스트 + 처리 상태 뱃지 + 결과 요약 패널로 피드백 강화
  - 실패 원인(권한/검증/네트워크)을 구분해 바로 안내
- 우선순위: Should
- 대상 파일:
  - `app/admin/discussions/page.tsx`
  - `app/admin/safety/page.tsx`

#### Day 8-11 UX/UI 피드백 패턴 적용
- 권한 차단 UI 명확화 (Must)
  - 비관리자 접근 시 차단 안내 문구 + 이동 액션 제공
  - 관리자 버튼/메뉴는 노출 단계에서 선차단
- 운영 화면 피드백 강화 (Should)
  - 관리자 배치성 액션은 성공/실패 건수 요약 표시
  - 실패 원인을 유형별로 분리 안내
- 운영 mock 데이터 정책 (Should)
  - 운영 환경에서는 mock 데이터 비노출
  - 빈 상태 문구와 다음 액션 가이드로 대체

### 백엔드
1) 관리자 API 인가 검증 공통화
- 현상: 관리자 API 다수에서 인증/관리자 권한 검증이 라우트 내부에 명시되지 않음
- 리스크: 민감 액션(승인/반려/삭제/규칙관리) 비인가 호출 가능
- 개선권고:
  - `requireAdmin()` 유틸 도입 후 전 관리자 API 공통 적용
  - 감사 로그에 actor(email/id) 필수 기록
- 우선순위: Must
- 대상 파일:
  - `app/api/admin/discussions/route.ts`
  - `app/api/admin/discussions/[id]/route.ts`
  - `app/api/admin/safety/rules/route.ts`
  - `app/api/admin/safety/pending/route.ts`
  - `app/api/admin/safety/pending/[id]/route.ts`

2) 로그 무결성 강화
- 현상: `writeAdminLog` 호출은 있으나 admin 식별자 누락 시나리오 존재(체크리스트 기준 운영 준비 미완료)
- 리스크: 사후 감사 시 책임 추적 어려움
- 개선권고:
  - 로그 스키마에 `admin_email`, `request_id`, `ip_hash` 저장
  - 관리자 인증 실패/권한 거부 이벤트도 로그에 남김
- 우선순위: Should
- 대상 파일:
  - `app/api/admin/discussions/[id]/route.ts`
  - `app/api/admin/safety/rules/route.ts`
  - `app/api/admin/safety/pending/[id]/route.ts`
  - `app/api/admin/logs/route.ts`

3) 토론 상태 전이 규칙 명시화
- 현상: `승인/반려/복구/종료` 액션은 존재하나 상태 전이 제약이 코드상 분산
- 리스크: 잘못된 상태 전이(예: 반려->종료 등) 허용 가능성
- 개선권고:
  - 상태 전이 매트릭스 도입(허용/불가 명시)
  - 전이 실패는 409로 표준 응답
- 우선순위: Should
- 대상 파일:
  - `app/api/admin/discussions/[id]/route.ts`
  - `app/api/discussions/[id]/route.ts`
  - `app/community/[id]/page.tsx`

4) 세이프티 규칙 운영 스키마 확장
- 현상: 현재는 `kind=banned_word` 중심 단일 규칙
- 리스크: 정책 확장(허용어, 문맥 예외, 사용자 제재) 대응 어려움
- 개선권고:
  - 규칙 우선순위/활성여부/만료일 컬럼 추가
  - 규칙 캐시 및 버전 필드 도입
- 우선순위: Could
- 대상 파일:
  - `app/api/admin/safety/rules/route.ts`
  - `lib/safety.ts`
  - `supabase/schema.sql`

---

## 공통 미완료 항목 기반 권고

1) 관리자 접근 인증 배포체크 자동화
- 현상: 체크리스트에 수동 점검 항목으로 남아 있음
- 개선권고:
  - CI에서 `ADMIN_EMAILS` 존재 여부, `/admin` 보호 여부 스모크 테스트 추가
- 우선순위: Must
- 대상 파일:
  - `middleware.ts`
  - `.env.local`
  - 배포 환경변수 설정

2) 이메일 알림 운영연동 완료
- 현상: Resend 설정/트리거 연동이 미완료
- 개선권고:
  - 신규 이슈/검토 댓글 발생 시 관리자 알림 훅 연결
  - 실패 재시도 및 dead-letter 로그 추가
- 우선순위: Should
- 대상 파일:
  - `lib/email.ts`
  - `app/api/comments/route.ts`
  - `app/api/issues/route.ts`

---

## 우선 실행 권고 (Top 10)

1. `/admin`, `/api/admin` 관리자 인가 강제 (Must)
2. 댓글 검토 상태값 `pending`/`pending_review` 불일치 해결 (Must)
3. 세이프티 검증 로직 공통화(생성/수정/토론/관리자수정) (Must)
4. 분산 환경용 Rate Limit(메모리 Map 대체) 적용 (Must)
5. 투표 참여/취소 트랜잭션 원자화 (Must)
6. 관리자 버튼/경로 보호 재연결 및 배포체크 자동화 (Must)
7. 검색 로직 단일 경로화(`/api/search` vs 서버직접조회) (Should)
8. 목록/검색 요청 취소 및 최신응답 보장 도입 (Should)
9. 관리자 mock 데이터 운영 비노출 정책 적용 (Should)
10. 로그 스키마 강화(actor/request 단위 추적) (Should)
