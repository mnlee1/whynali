# 1단계: 기초·공통 픽스

98_로드맵 1단계에서 합의·픽스할 항목을 문서로 고정한다. 분할 전 둘 다 합의 후 픽스하고, dev 머지 완료 후 2단계 진행.

**2단계 담당 (98_로드맵 기준)**  
- **담당 A**: 이슈·타임라인·이슈 목록(검색/필터)·수집·화력. 홈·카테고리·이슈 목록·이슈 상세(화력·타임라인·출처). 관리자 이슈/수집/화력.  
- **담당 B**: 감정·댓글·투표·토론 주제·토론 댓글·세이프티·글로벌 검색·Auth. 이슈 상세(감정·댓글·투표)·커뮤니티·검색·로그인. 관리자 토론 주제·세이프티.

이슈 등록 조건·화력 계산·목록 정렬 규칙은 **07_이슈등록_화력_정렬_규격.md** 참조 (동시 작업 시 구현 기준).

아래 담당 A/B 표기는 2단계 구현 시 참고용.

---

## 1. 환경

### 1.1 저장소·프로젝트

- 저장소: GitHub Private. 2명 협업, main(또는 production) + dev 브랜치.
- Next.js 14+ (App Router) 프로젝트 생성. TypeScript, ESLint 사용.
- 로컬 실행: `npm install` 후 `npm run dev`. 포트 3000.

### 1.2 기술 스택 (01_AI기획 §13, 02 §7 참조)

| 구분 | 기술 |
|------|------|
| 프론트 | Next.js 14+ (App Router), React |
| 백/DB | Supabase (PostgreSQL) |
| 인증 | Supabase Auth (구글·네이버·카카오) |
| 배포 | Vercel |
| 스케줄 | Vercel Cron (뉴스 수집) |
| 수집 | Supabase Edge Functions + Cheerio (커뮤니티) |
| 외부 | 네이버 뉴스 API, 네이버/카카오/구글 로그인 |

### 1.3 환경 변수 템플릿

프로젝트 루트에 `.env.example` 생성 후 아래 내용으로 채운다. 실제 값은 `.env.local`에만 저장(커밋 제외).

```
# Supabase
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=

# Naver (뉴스 API + 로그인)
NAVER_CLIENT_ID=
NAVER_CLIENT_SECRET=

# Kakao
NEXT_PUBLIC_KAKAO_CLIENT_ID=
KAKAO_CLIENT_SECRET=

# Google
NEXT_PUBLIC_GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=
```

화력 분석용 AI 사용 시: 해당 API 키 변수 추가(선택).

---

## 2. 기획·메뉴·데이터 목록

### 2.1 기능 목록 (MVP)

- 이슈 목록(카테고리별·상태별 필터), 이슈 상세, 타임라인 시각화, 화력 분석
- 뉴스 수집(네이버 API 30분), 커뮤니티 메타 수집(더쿠·네이트판 3분), 이슈 자동 연결
- 오픈ID 로그인(구글·네이버·카카오), 감정 7종, 댓글(베스트 상단 + 리스트 정렬), 투표(이슈당 복수·시점별)
- 커뮤니티: AI 토론 주제 생성 → 관리자 승인 → 등록, 유저 토론 댓글
- 관리자: 이슈 승인, 화력 반영, 수집 확인·이슈 연결, 토론 주제 승인, 세이프티봇 검토

### 2.2 DB에 넣을 데이터 목록 (본문·요약문·수집 닉네임 없음)

| 데이터 | 저장 내용 | 담당 |
|--------|-----------|------|
| 이슈 | 제목, 설명, 상태(점화/논란중/종결), 카테고리(연예/스포츠/정치/사회/기술), 화력 지수, 승인 상태·일시 | A |
| 타임라인 | 시간, 출처 링크, 이슈 ID, 단계(발단/전개/파생/진정) | A |
| 유저 | 오픈ID 식별자, 프로필(닉네임 등). 닉네임 수집 최소화 | B |
| 감정 | 이슈별 사용자별 타입(7종), 집계용 | B |
| 댓글 | 내용, 작성자, 이슈 ID 또는 토론 주제 ID, 좋아요/싫어요 수(또는 score), 공개/검토대기/삭제 | B |
| 투표·선택지 | 이슈별 복수 투표, 시점/상태, 선택지 내용·득표수 | B |
| 토론 주제 | 이슈 ID, 주제 문장, AI 생성 여부, 승인 상태·일시 | B |
| 뉴스 수집 | 제목, 링크, 출처, 날짜(메타데이터만) | A |
| 커뮤니티 수집 | 제목, URL, 조회수, 댓글수, 작성시간(메타데이터만) | A |
| 금칙어·설정 | 세이프티봇 룰 | B |
| 관리자 로그 | 승인·반려 기록 | A·B |

### 2.3 메뉴 구조 (98_로드맵 §3 요약)

- **상단**: [로고/홈] [연예][스포츠][정치][사회][기술] [커뮤니티] [검색] [로그인]
- **글로벌 검색**: 이슈 + 토론 주제 통합.
- **카테고리 메뉴**: 해당 카테고리 이슈 목록 → 페이지 내 검색·필터(상태, 정렬) → 이슈 상세.
- **이슈 상세**: 화력·상태, 타임라인, 감정·댓글·투표, "이 이슈의 커뮤니티" 링크.
- **커뮤니티**: 토론 주제 목록(검색·필터) → 토론 주제 상세(댓글).
- **관리자**: 이슈/타임라인 CRUD, 수집(뉴스·커뮤니티)·이슈 연결, 화력·토론 주제 승인, 세이프티봇 검토.

### 2.4 화면별 사용 데이터

| 화면 | 사용 데이터(API/테이블) | 담당 |
|------|--------------------------|------|
| 홈 / 카테고리 목록 | 이슈 목록 API (issues) | A |
| 이슈 상세 | 이슈 상세, 타임라인 포인트, 출처 목록(뉴스·커뮤니티), 감정 집계, 댓글, 투표 | A(화력·타임라인·출처) / B(감정·댓글·투표) |
| 커뮤니티 목록 | 토론 주제 목록 API (discussion_topics) | B |
| 토론 주제 상세 | 토론 주제 상세, 토론 댓글 | B |
| 글로벌 검색 | 이슈 + 토론 주제 통합 검색 API | B |
| 관리자 – 이슈/수집/화력 | 해당 CRUD·목록·승인 API | A |
| 관리자 – 토론 주제·세이프티 | 토론 주제 승인·검토 대기 API | B |

---

## 3. DB 스키마

02_AI기획_판단포인트 §8.3 기준. Supabase에 테이블 생성 시 아래 스키마를 따른다. 본문·요약문·수집 닉네임 컬럼 없음.

### 3.1 테이블 목록·컬럼·타입

**issues** (담당 A)

| 컬럼 | 타입 | 비고 |
|------|------|------|
| id | uuid | PK, default gen_random_uuid() |
| title | text | NOT NULL |
| description | text | |
| status | text | 점화\|논란중\|종결 |
| category | text | 연예\|스포츠\|정치\|사회\|기술 |
| heat_index | numeric | 화력 지수 |
| approval_status | text | 대기\|승인\|반려 |
| approved_at | timestamptz | |
| created_at | timestamptz | default now() |
| updated_at | timestamptz | default now() |

**timeline_points** (담당 A)

| 컬럼 | 타입 | 비고 |
|------|------|------|
| id | uuid | PK |
| issue_id | uuid | FK → issues(id) |
| occurred_at | timestamptz | |
| source_url | text | 출처 링크 |
| stage | text | 발단\|전개\|파생\|진정 |
| created_at | timestamptz | default now() |

**users** (담당 B)

| 컬럼 | 타입 | 비고 |
|------|------|------|
| id | uuid | PK (Supabase auth.users 연동 시 동일 ID 사용 가능) |
| provider | text | 구글\|네이버\|카카오 |
| provider_id | text | 오픈ID 식별자 |
| display_name | text | 선택 |
| created_at | timestamptz | default now() |

**reactions** (담당 B)

| 컬럼 | 타입 | 비고 |
|------|------|------|
| id | uuid | PK |
| issue_id | uuid | FK → issues(id) |
| user_id | uuid | FK → users(id) |
| type | text | 좋아요\|싫어요\|화나요\|팝콘각\|응원\|애도\|사이다 |
| created_at | timestamptz | default now() |

**comments** (담당 B)

| 컬럼 | 타입 | 비고 |
|------|------|------|
| id | uuid | PK |
| issue_id | uuid | FK → issues(id), nullable(토론 댓글이면 null) |
| discussion_topic_id | uuid | FK → discussion_topics(id), nullable |
| user_id | uuid | FK → users(id) |
| body | text | NOT NULL |
| like_count | int | default 0 |
| dislike_count | int | default 0 |
| visibility | text | public\|pending_review\|deleted |
| parent_id | uuid | FK → comments(id), nullable(대댓글) |
| created_at | timestamptz | default now() |
| updated_at | timestamptz | default now() |

**votes** (담당 B)

| 컬럼 | 타입 | 비고 |
|------|------|------|
| id | uuid | PK |
| issue_id | uuid | FK → issues(id) |
| title | text | 투표 제목/시점 설명 |
| phase | text | 시점/상태(선택) |
| created_at | timestamptz | default now() |

**vote_choices** (담당 B)

| 컬럼 | 타입 | 비고 |
|------|------|------|
| id | uuid | PK |
| vote_id | uuid | FK → votes(id) |
| label | text | 선택지 문구 |
| count | int | default 0 |

**user_votes** (투표 제출 기록, 담당 B)

| 컬럼 | 타입 | 비고 |
|------|------|------|
| id | uuid | PK |
| vote_id | uuid | FK → votes(id) |
| vote_choice_id | uuid | FK → vote_choices(id) |
| user_id | uuid | FK → users(id) |
| created_at | timestamptz | default now() |

**discussion_topics** (담당 B)

| 컬럼 | 타입 | 비고 |
|------|------|------|
| id | uuid | PK |
| issue_id | uuid | FK → issues(id) |
| body | text | 토론 주제 문장 |
| is_ai_generated | boolean | default false |
| approval_status | text | 대기\|승인\|반려 |
| approved_at | timestamptz | |
| created_at | timestamptz | default now() |

**news_data** (담당 A)

| 컬럼 | 타입 | 비고 |
|------|------|------|
| id | uuid | PK |
| title | text | |
| link | text | |
| source | text | 출처명 |
| published_at | timestamptz | |
| issue_id | uuid | FK → issues(id), nullable(연결 전 null) |
| created_at | timestamptz | default now() |

**community_data** (담당 A)

| 컬럼 | 타입 | 비고 |
|------|------|------|
| id | uuid | PK |
| title | text | |
| url | text | |
| view_count | int | |
| comment_count | int | |
| written_at | timestamptz | |
| source_site | text | 더쿠\|네이트판 등 |
| issue_id | uuid | FK → issues(id), nullable |
| created_at | timestamptz | default now() |

**safety_rules** (담당 B)

| 컬럼 | 타입 | 비고 |
|------|------|------|
| id | uuid | PK |
| kind | text | forbidden_word 등 |
| value | text | 키워드/설정값 |
| created_at | timestamptz | default now() |

**admin_logs** (담당 A·B)

| 컬럼 | 타입 | 비고 |
|------|------|------|
| id | uuid | PK |
| action | text | 승인\|반려 등 |
| target_type | text | issue\|discussion_topic\|comment 등 |
| target_id | uuid | |
| admin_id | uuid | FK → users(id) |
| created_at | timestamptz | default now() |

### 3.2 인덱스 권장

- issues: category, status, approval_status, created_at
- comments: issue_id, discussion_topic_id, visibility, created_at
- timeline_points: issue_id
- news_data, community_data: issue_id, created_at

---

## 4. API 규약·공통 타입

저장소에 [97_API규약.md](./97_API규약.md)로 보관. 아래는 핵심만 요약. 괄호 안 담당은 2단계 구현 담당.

### 4.1 공통

- REST. JSON. 인증 필요 API는 Authorization: Bearer \<Supabase JWT\>.
- 에러: `{ "error": "코드", "message": "설명" }`, HTTP 4xx/5xx.

### 4.2 이슈 목록 (담당 A)

- `GET /api/issues` (또는 Next.js Route Handler 경로 팀 합의)
- Query: `category`, `status`, `q`(키워드), `sort`(latest|heat), `limit`, `offset`
- 응답 예시:

```json
{
  "data": [
    {
      "id": "uuid",
      "title": "string",
      "description": "string",
      "status": "점화|논란중|종결",
      "category": "연예|스포츠|정치|사회|기술",
      "heat_index": 0,
      "created_at": "ISO8601"
    }
  ],
  "total": 0
}
```

### 4.3 이슈 상세 (담당 A)

- `GET /api/issues/[id]`
- 응답: 위 이슈 필드 + (선택) 타임라인 요약 개수, 댓글 수, 감정 집계 요약.

### 4.4 타임라인·출처 (담당 A)

- `GET /api/issues/[id]/timeline` → `{ "data": [ { "id", "occurred_at", "source_url", "stage" } ] }`
- `GET /api/issues/[id]/sources` → 뉴스·커뮤니티 수집 데이터 목록(제목, 링크, 출처, 날짜 등).

### 4.5 댓글 (담당 B)

- `GET /api/issues/[id]/comments` 또는 `GET /api/discussion-topics/[id]/comments`
- Query: `sort`(latest|likes|dislikes), `limit`, `offset`
- 응답: `{ "data": [ { "id", "body", "user_id", "like_count", "dislike_count", "created_at" } ] }`
- `POST` 댓글: body `{ "body": "string" }`. 세이프티봇 적용 후 visibility 반영.

### 4.6 투표 (담당 B)

- `GET /api/issues/[id]/votes` → 투표 목록 + 선택지별 득표.
- `POST /api/issues/[id]/votes/[voteId]` body `{ "vote_choice_id": "uuid" }` (로그인 필수).

### 4.7 토론 주제 (담당 B)

- `GET /api/discussion-topics` Query: `issue_id`, `q`, `limit`, `offset`
- `GET /api/discussion-topics/[id]` 상세
- 목록/상세 응답: `{ "id", "issue_id", "body", "approval_status", "created_at" }` (승인된 것만 공개 API에서 반환)

### 4.8 글로벌 검색 (담당 B)

- `GET /api/search?q=키워드&type=all|issues|discussion_topics&limit=`
- 응답: `{ "issues": [ ... ], "discussion_topics": [ ... ] }`

---

## 5. 앱 뼈대 (선택)

2단계 분할 후 A/B가 각자 해당 경로·컴포넌트만 채우도록 라우팅·레이아웃을 먼저 픽스한다.

### 5.1 Next.js 라우팅 구조 (App Router)

| 경로 | 담당 | 비고 |
|------|------|------|
| layout.tsx, page.tsx (홈) | A | 공통 레이아웃은 둘 다 사용 |
| entertain, sports, politics, society, tech | A | 카테고리별 이슈 목록 |
| issue/[id] | A(화력·타임라인·출처) / B(감정·댓글·투표) | 한 페이지 내 컴포넌트 분할 |
| community, community/[id] | B | 토론 주제 목록·상세 |
| search | B | 글로벌 검색 |
| admin | A(이슈/수집/화력) / B(토론·세이프티) | 메뉴별 담당 |

```
app/
  layout.tsx                 # 루트 레이아웃 (공통 헤더·메뉴·검색 자리)
  page.tsx                   # 홈 (담당 A)
  (public)/
    entertain/   page.tsx    # 연예 (A)
    sports/      page.tsx    # 스포츠 (A)
    politics/    page.tsx    # 정치 (A)
    society/     page.tsx    # 사회 (A)
    tech/        page.tsx    # 기술 (A)
    community/   page.tsx    # 커뮤니티 토론 주제 목록 (B)
    community/[id]/ page.tsx # 토론 주제 상세 (B)
    issue/[id]/  page.tsx    # 이슈 상세 (A+B 컴포넌트 합침)
  search/        page.tsx    # 글로벌 검색 (B)
  admin/         ...        # 관리자 (A·B 메뉴별)
```

경로명(entertain, sports 등)은 팀 합의로 통일.

### 5.2 공통 레이아웃

- **헤더**: 로고(홈 링크), 카테고리 메뉴(연예~기술), 커뮤니티 링크, 검색 트리거, 로그인/프로필. (카테고리·홈 링크 쪽 A, 검색·로그인 쪽 B 연동)
- **검색**: 상단 검색창 또는 검색 아이콘 클릭 시 모달/전용 페이지. 이슈+토론 주제 통합 검색 결과 표시 자리. (담당 B)
- **푸터**(선택): 약관·연락처 등.

레이아웃용 컴포넌트: `components/layout/Header.tsx`, `Nav.tsx`, `SearchBar.tsx` 등 플레이스홀더 생성 후, 2단계에서 담당 A/B가 각자 해당 영역만 채운다.

---

## 6. 1단계 완료 체크

- [ ] 저장소 생성, Next.js 프로젝트 생성
- [ ] 기술 스택·로컬 실행 방법 문서화, .env.example 반영
- [ ] 기능 목록·DB 데이터 목록·메뉴 구조·화면별 데이터 합의
- [ ] Supabase 테이블 생성(위 스키마 기준)
- [ ] [97_API규약.md](./97_API규약.md) 등 API 규약 문서 저장
- [ ] (선택) 앱 뼈대 라우팅·공통 레이아웃 픽스
- [ ] dev 브랜치에 머지 후, 2단계 시작 전 `git pull origin dev` 실행
