# whynali/.github/workflows/dooray-pr-notify.yml
#
# Pull Request ì´ë²¤íŠ¸(ì—´ë¦¼/ë¨¸ì§€/ë‹«í˜) ë°œìƒ ì‹œ ë‘ë ˆì´ ë©”ì‹ ì €ë¡œ ì•Œë¦¼ì„ ë³´ëƒ…ë‹ˆë‹¤.
# DOORAY_WEBHOOK_URL ì‹œí¬ë¦¿ì´ ìˆì–´ì•¼ ë™ì‘í•©ë‹ˆë‹¤.

name: Dooray PR notification
on:
    pull_request:
        types: [opened, closed, reopened, synchronize]
jobs:
    notify:
        runs-on: ubuntu-latest
        steps:
            - name: Notify Dooray (PR)
              env:
                  DOORAY_WEBHOOK_URL: ${{ secrets.DOORAY_WEBHOOK_URL }}
                  PR_ACTION: ${{ github.event.action }}
                  PR_TITLE: ${{ github.event.pull_request.title }}
                  PR_AUTHOR: ${{ github.event.pull_request.user.login }}
                  PR_URL: ${{ github.event.pull_request.html_url }}
                  PR_STATE: ${{ github.event.pull_request.state }}
                  PR_MERGED: ${{ github.event.pull_request.merged }}
                  PR_NUM: ${{ github.event.pull_request.number }}
                  REPO: ${{ github.repository }}
                  BRANCH: ${{ github.head_ref }}
              run: |
                  if [ -z "$DOORAY_WEBHOOK_URL" ]; then exit 0; fi
                  case "$PR_ACTION" in
                      opened)   TITLE="ìƒˆ PRì´ ì—´ë ¸ìŠµë‹ˆë‹¤"; COLOR="blue";;
                      closed)
                          if [ "$PR_MERGED" = "true" ]; then
                              TITLE="PRì´ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤"
                              COLOR="green"
                          else
                              TITLE="PRì´ ë‹«í˜”ìŠµë‹ˆë‹¤"
                              COLOR="gray"
                          fi
                          ;;
                      reopened) TITLE="PRì´ ë‹¤ì‹œ ì—´ë ¸ìŠµë‹ˆë‹¤"; COLOR="blue";;
                      synchronize) TITLE="PRì— ìƒˆ ì»¤ë°‹ì´ í‘¸ì‹œë˜ì—ˆìŠµë‹ˆë‹¤"; COLOR="default";;
                      *) TITLE="PR ì•Œë¦¼"; COLOR="default";;
                  esac
                  ATTACH_TITLE="#${PR_NUM} ${PR_TITLE}"
                  ATTACH_TEXT="ğŸ‘¤ ì‘ì„±ì: ${PR_AUTHOR}"$'\n'"ğŸ“‚ ì €ì¥ì†Œ: ${REPO}"$'\n'"ğŸŒ¿ ë¸Œëœì¹˜: ${BRANCH}"$'\n\n'"ğŸ”— [PR ë³´ê¸°](${PR_URL})"
                  BODY=$(jq -n \
                      --arg bot "Git ì•Œë¦¼" \
                      --arg text "$TITLE" \
                      --arg atitle "$ATTACH_TITLE" \
                      --arg url "$PR_URL" \
                      --arg atext "$ATTACH_TEXT" \
                      --arg color "$COLOR" \
                      '{botName: $bot, text: $text, attachments: [{title: $atitle, titleLink: $url, text: $atext, color: $color}]}')
                  curl -s -X POST "$DOORAY_WEBHOOK_URL" \
                      -H "Content-Type: application/json" \
                      -d "$BODY"
