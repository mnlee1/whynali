name: Dooray push notification
on:
    push:
jobs:
    notify:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 2

            - name: Get changed files
              id: changed
              run: |
                  git diff --name-only HEAD^ HEAD > changed_files.txt
                  cat changed_files.txt
                  echo "files<<EOF" >> $GITHUB_OUTPUT
                  cat changed_files.txt >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Check common files
              id: check
              run: |
                  if grep -qE '(common|shared|components/common|utils/common|styles/common)' changed_files.txt; then
                      echo "is_common=true" >> $GITHUB_OUTPUT
                  else
                      echo "is_common=false" >> $GITHUB_OUTPUT
                  fi

            - name: Notify Dooray (common files)
              if: steps.check.outputs.is_common == 'true'
              env:
                  DOORAY_WEBHOOK_URL: ${{ secrets.DOORAY_WEBHOOK_URL }}
              run: |
                  if [ -z "$DOORAY_WEBHOOK_URL" ]; then exit 0; fi
                  REPO="${{ github.repository }}"
                  BRANCH="${GITHUB_REF#refs/heads/}"
                  COMMIT="${{ github.sha }}"
                  MSG="${{ github.event.head_commit.message }}"
                  ACTOR="${{ github.actor }}"
                  COMMIT_URL="https://github.com/$REPO/commit/$COMMIT"
                  FILES=$(cat changed_files.txt | sed 's/^/â€¢ /' | tr '\n' '\n')
                  BODY=$(cat <<EOF
                  {
                      "botName": "Git ì•Œë¦¼",
                      "text": "ðŸš¨ ê³µí†µ íŒŒì¼ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!",
                      "attachments": [{
                          "title": "ì»¤ë°‹ ë³´ê¸°",
                          "titleLink": "$COMMIT_URL",
                          "text": "ðŸ“ ë³€ê²½ëœ íŒŒì¼:\n$FILES\n\nðŸ‘¤ ìž‘ì—…ìž: $ACTOR\nðŸ’¬ ì»¤ë°‹ ë©”ì‹œì§€: $MSG\nðŸ”— ì»¤ë°‹ ë§í¬: $COMMIT_URL\n\nâš ï¸ íŒ€ì› ì—¬ëŸ¬ë¶„, git pull í•˜ì„¸ìš”!",
                          "color": "red"
                      }]
                  }
                  EOF
                  )
                  curl -s -X POST "$DOORAY_WEBHOOK_URL" \
                      -H "Content-Type: application/json" \
                      -d "$BODY"

            - name: Notify Dooray (normal push)
              if: steps.check.outputs.is_common == 'false'
              env:
                  DOORAY_WEBHOOK_URL: ${{ secrets.DOORAY_WEBHOOK_URL }}
              run: |
                  if [ -z "$DOORAY_WEBHOOK_URL" ]; then exit 0; fi
                  REPO="${{ github.repository }}"
                  BRANCH="${GITHUB_REF#refs/heads/}"
                  COMMIT="${{ github.sha }}"
                  MSG="${{ github.event.head_commit.message }}"
                  ACTOR="${{ github.actor }}"
                  COMMIT_URL="https://github.com/$REPO/commit/$COMMIT"
                  BODY=$(cat <<EOF
                  {
                      "botName": "Git ì•Œë¦¼",
                      "text": "ðŸ“¢ ìƒˆë¡œìš´ ì»¤ë°‹ì´ í‘¸ì‹œë˜ì—ˆìŠµë‹ˆë‹¤",
                      "attachments": [{
                          "title": "ì»¤ë°‹ ë³´ê¸°",
                          "titleLink": "$COMMIT_URL",
                          "text": "ðŸ‘¤ ìž‘ì—…ìž: $ACTOR\nðŸ“ ë¸Œëžœì¹˜: $BRANCH\nðŸ’¬ ì»¤ë°‹ ë©”ì‹œì§€: $MSG\nðŸ”— ì»¤ë°‹ ë§í¬: $COMMIT_URL",
                          "color": "blue"
                      }]
                  }
                  EOF
                  )
                  curl -s -X POST "$DOORAY_WEBHOOK_URL" \
                      -H "Content-Type: application/json" \
                      -d "$BODY"